{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –∑–∞–¥–∞–Ω–∏—è</h2>
    
    <div class="alert alert-info">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ 3, 4, 5 –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∑–∞—è–≤–∫–∏.
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <div class="query-buttons">
        <button onclick="loadQuery(1)" class="btn btn-primary">1. –¢–µ–∫—É—â–∏–µ –∑–∞—è–≤–∫–∏</button>
        <button onclick="loadQuery(2)" class="btn btn-success">2. –ó–∞–∫—Ä—ã—Ç—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</button>
        <button onclick="loadQuery(3, 2)" class="btn btn-warning">3. –ó–∞—è–≤–∫–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</button>
        <button onclick="loadQuery(4, 1)" class="btn btn-info">4. –ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <button onclick="loadQuery(5, 1)" class="btn btn-secondary">5. –°–æ–∑–¥–∞—Ç–µ–ª—å –∑–∞—è–≤–∫–∏</button>
    </div>
    
    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <div class="query-params mt-3" id="queryParams" style="display: none;">
        <label for="paramInput">–í–≤–µ–¥–∏—Ç–µ ID:</label>
        <input type="number" id="paramInput" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–∑–∞—è–≤–∫–∏" 
               min="1" class="param-input">
        <button onclick="loadCurrentQuery()" class="btn btn-primary">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="results" class="mt-4">
        <div class="alert alert-info" id="noResults">
            –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        </div>
        
        <div id="resultsTable" style="display: none;">
            <h3 id="queryTitle"></h3>
            <div class="table-responsive">
                <table class="table" id="resultsTableContent">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="userInfo" style="display: none;">
            <h3 id="userTitle"></h3>
            <div class="card" id="userCard"></div>
        </div>
    </div>
    
    <div class="mt-4">
        <h4>üìã –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤:</h4>
        <div class="query-descriptions">
            <div class="query-desc">
                <h5>1. –¢–µ–∫—É—â–∏–µ –∑–∞—è–≤–∫–∏</h5>
                <p>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "open" –∏–ª–∏ "in_progress", –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –∏ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è.</p>
            </div>
            <div class="query-desc">
                <h5>2. –ó–∞–∫—Ä—ã—Ç—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</h5>
                <p>–ó–∞—è–≤–∫–∏, –∑–∞–∫—Ä—ã—Ç—ã–µ –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ, —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–º, –∫—Ç–æ –∑–∞–∫—Ä—ã–ª –∏ –∫–æ–≥–¥–∞.</p>
            </div>
            <div class="query-desc">
                <h5>3. –ó–∞—è–≤–∫–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</h5>
                <p>–í—Å–µ –∑–∞—è–≤–∫–∏, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.</p>
            </div>
            <div class="query-desc">
                <h5>4. –ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <p>–í—Å–µ –∑–∞—è–≤–∫–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.</p>
            </div>
            <div class="query-desc">
                <h5>5. –°–æ–∑–¥–∞—Ç–µ–ª—å –∑–∞—è–≤–∫–∏</h5>
                <p>–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, —Å–æ–∑–¥–∞–≤—à–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞—è–≤–∫—É.</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuery = 0;
let currentParam = null;

function loadQuery(queryNumber, defaultParam = null) {
    currentQuery = queryNumber;
    currentParam = defaultParam;
    
    const paramDiv = document.getElementById('queryParams');
    const paramInput = document.getElementById('paramInput');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ 3,4,5
    if (queryNumber === 3 || queryNumber === 4 || queryNumber === 5) {
        paramDiv.style.display = 'block';
        if (defaultParam) {
            paramInput.value = defaultParam;
        } else {
            paramInput.value = '';
        }
    } else {
        paramDiv.style.display = 'none';
        executeQuery();
    }
}

function loadCurrentQuery() {
    const paramInput = document.getElementById('paramInput');
    currentParam = paramInput.value || currentParam;
    
    if ((currentQuery === 3 || currentQuery === 4 || currentQuery === 5) && !currentParam) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID');
        return;
    }
    
    executeQuery();
}

function executeQuery() {
    const urls = {
        1: '/api/tickets',
        2: '/api/tickets/closed-this-month',
        3: `/api/tickets/by-responsible/${currentParam}`,
        4: `/api/tickets/by-user/${currentParam}`,
        5: `/api/ticket/${currentParam}/creator`
    };
    
    const titles = {
        1: 'üìã –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö –∑–∞—è–≤–æ–∫',
        2: 'üìÖ –ó–∞—è–≤–∫–∏, –∑–∞–∫—Ä—ã—Ç—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ',
        3: `üëî –ó–∞—è–≤–∫–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (ID: ${currentParam})`,
        4: `üë§ –ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID: ${currentParam})`,
        5: `‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ –∑–∞—è–≤–∫–∏ (ID –∑–∞—è–≤–∫–∏: ${currentParam})`
    };
    
    const url = urls[currentQuery];
    if (!url) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById('noResults').style.display = 'block';
    document.getElementById('noResults').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    document.getElementById('resultsTable').style.display = 'none';
    document.getElementById('userInfo').style.display = 'none';
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('noResults').style.display = 'none';
            
            if (currentQuery === 5) {
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                showUserInfo(data, titles[currentQuery]);
            } else {
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∑–∞—è–≤–∫–∞–º–∏
                showTable(data, titles[currentQuery]);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('noResults').innerHTML = 
                `<div class="alert alert-error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</div>`;
        });
}

function showTable(data, title) {
    if (!data || (Array.isArray(data) && data.length === 0)) {
        document.getElementById('tableBody').innerHTML = 
            '<tr><td colspan="10" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        document.getElementById('resultsTable').style.display = 'block';
        document.getElementById('queryTitle').textContent = title;
        return;
    }
    
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('resultsTable').style.display = 'block';
    document.getElementById('queryTitle').textContent = title;
    
    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    const headers = Object.keys(data[0]);
    const headerHtml = headers.map(h => 
        `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`
    ).join('');
    document.getElementById('tableHeader').innerHTML = `<tr>${headerHtml}</tr>`;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
    const bodyHtml = data.map(row => {
        const cells = headers.map(h => {
            let value = row[h];
            if (value === null || value === undefined) value = '-';
            if (typeof value === 'string' && value.length > 100) {
                value = value.substring(0, 100) + '...';
            }
            return `<td>${value}</td>`;
        }).join('');
        return `<tr>${cells}</tr>`;
    }).join('');
    
    document.getElementById('tableBody').innerHTML = bodyHtml;
}

function showUserInfo(userData, title) {
    if (!userData || userData.error) {
        document.getElementById('userCard').innerHTML = 
            '<div class="alert alert-warning">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('userTitle').textContent = title;
        return;
    }
    
    document.getElementById('resultsTable').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
    document.getElementById('userTitle').textContent = title;
    
    const userHtml = `
        <div class="card-body">
            <h4 class="card-title">üë§ ${userData.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Email:</strong> ${userData.email || '-'}</p>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${userData.phone || '-'}</p>
                    <p><strong>–†–æ–ª—å:</strong> ${userData.role || '-'}</p>
                    <p><strong>–û—Ç–¥–µ–ª:</strong> ${userData.department || '-'}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</strong> ${userData.user_registered || '-'}</p>
                    <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong> ${userData.last_login || '-'}</p>
                    <p><strong>–ê–∫—Ç–∏–≤–µ–Ω:</strong> ${userData.is_active ? '–î–∞' : '–ù–µ—Ç'}</p>
                </div>
            </div>
            <hr>
            <h5>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="stat-card small">
                        <span class="stat-number">${userData.total_tickets || 0}</span>
                        <span class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card small">
                        <span class="stat-number">${userData.open_tickets || 0}</span>
                        <span class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã–µ</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card small">
                        <span class="stat-number">${userData.closed_tickets || 0}</span>
                        <span class="stat-label">–ó–∞–∫—Ä—ã—Ç—ã–µ</span>
                    </div>
                </div>
            </div>
            ${userData.last_ticket ? `<p class="mt-3"><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞—è–≤–∫–∞:</strong> ${userData.last_ticket}</p>` : ''}
        </div>
    `;
    
    document.getElementById('userCard').innerHTML = userHtml;
}
</script>

<style>
.query-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.query-buttons .btn {
    min-width: 200px;
    padding: 10px 15px;
}

.query-params {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.query-params label {
    margin-right: 10px;
    font-weight: bold;
}

.param-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 200px;
    margin-right: 10px;
}

.table-responsive {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 10;
    padding: 12px;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
}

.table tr:hover {
    background-color: #f5f5f5;
}

.query-descriptions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.query-desc {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.query-desc h5 {
    margin-top: 0;
    color: #2c3e50;
}

.query-desc p {
    margin-bottom: 0;
    color: #666;
}

.stat-card.small {
    padding: 10px;
    text-align: center;
}

.stat-card.small .stat-number {
    font-size: 1.5rem;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}
</style>
{% endblock %}